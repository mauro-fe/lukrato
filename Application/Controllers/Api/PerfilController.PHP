<?php

namespace Application\Controllers\Api;

use Application\Core\Response;
use Application\Lib\Auth;
use Illuminate\Database\Capsule\Manager as DB;
use Illuminate\Database\Eloquent\Builder;
use Application\Models\Usuario;
use Application\Models\Sexo;
use Application\Models\TipoDocumento;
use Application\Models\Documento;
use Application\Models\Telefone;
use Application\Models\Endereco;
use Application\Models\Ddd;
use Throwable; // Captura Exceptions e Errors

class PerfilController
{
    // --- M√©todos de Utilidade e Limpeza (Tipagem Aprimorada) ---

    /**
     * Remove caracteres n√£o-d√≠gitos de uma string.
     */
    private function digits(string $value): string
    {
        $digits = preg_replace('/\D+/', '', $value);
        return $digits ?? '';
    }

    /**
     * Valida um CPF (algoritmo padr√£o).
     */
    private function isValidCpf(string $cpf): bool
    {
        $cpf = $this->digits($cpf); // Garantir que s√≥ d√≠gitos cheguem aqui
        if (strlen($cpf) !== 11 || preg_match('/^(\d)\1{10}$/', $cpf)) {
            return false;
        }

        for ($t = 9; $t < 11; $t++) {
            $d = 0;
            for ($c = 0; $c < $t; $c++) {
                $d += (int) $cpf[$c] * (($t + 1) - $c);
            }
            $d = ((10 * $d) % 11) % 10;
            if ((int) $cpf[$t] !== $d) {
                return false;
            }
        }
        return true;
    }

    /**
     * Converte data em formatos variados (DD/MM/YYYY ou string) para YYYY-MM-DD.
     */
    private function parseDate(?string $value): ?string
    {
        if (empty(trim((string)$value))) {
            return null;
        }

        $value = trim((string)$value);

        if (preg_match('~^\d{2}/\d{2}/\d{4}$~', $value)) {
            [$dd, $mm, $yy] = explode('/', $value);
            if (checkdate((int) $mm, (int) $dd, (int) $yy)) {
                return sprintf('%04d-%02d-%02d', $yy, $mm, $dd);
            }
            return null;
        }

        $ts = strtotime($value);
        return $ts ? date('Y-m-d', $ts) : null;
    }

    /**
     * Extrai DDD e n√∫mero local do telefone bruto.
     * @return array{0: string|null, 1: string|null} [DDD, N√∫mero Local]
     */
    private function splitPhone(?string $value): array
    {
        $digits = $this->digits((string) $value);
        $len = strlen($digits);

        if ($len < 10 || $len > 11) {
            return [null, null];
        }

        $ddd = substr($digits, 0, 2);
        $local = substr($digits, 2);

        return [$ddd, $local];
    }

    /**
     * Normaliza e mapeia o valor de sexo para o Label do Banco de Dados.
     */
    private function mapSexoLabel(?string $value): ?string
    {
        if (empty(trim((string)$value))) {
            return null;
        }

        $normalized = $this->normalizeSexoValue((string)$value);

        return match ($normalized) {
            'M', 'MASCULINO' => 'Masculino',
            'F', 'FEMININO'  => 'Feminino',
            'O', 'OUTRO'     => 'Outro',
            'N', 'NAO INFORMADO', 'NAO-INFORMADO', 'NAO INFORMADA', 'PREFIRO NAO INFORMAR' => 'Nao informado',
            default          => null,
        };
    }

    /**
     * Normaliza valor de sexo para a op√ß√£o de retorno (M, F, O, N).
     */
    private function mapSexoToOption(?string $value): string
    {
        if (empty(trim((string)$value))) {
            return '';
        }

        $normalized = $this->normalizeSexoValue((string)$value);

        return match ($normalized) {
            'M', 'MASCULINO' => 'M',
            'F', 'FEMININO'  => 'F',
            'O', 'OUTRO'     => 'O',
            'N', 'NAO INFORMADO', 'NAO-INFORMADO', 'NAO INFORMADA', 'PREFIRO NAO INFORMAR' => 'N',
            default          => '',
        };
    }

    /**
     * Normaliza a string de sexo (acentos, espa√ßos, caixa alta).
     */
    private function normalizeSexoValue(string $value): string
    {
        // Simplifica√ß√£o: Depende menos do iconv e usa str_replace para os principais acentos
        $base = strtr($value, [
            '√Å' => 'A',
            '√â' => 'E',
            '√ç' => 'I',
            '√ì' => 'O',
            '√ö' => 'U',
            '√á' => 'C',
            '√É' => 'A',
            '√ï' => 'O',
            '√°' => 'A',
            '√©' => 'E',
            '√≠' => 'I',
            '√≥' => 'O',
            '√∫' => 'U',
            '√ß' => 'C',
            '√£' => 'A',
            '√µ' => 'O',
        ]);
        $base = str_replace(['-', '_', ' '], ' ', $base);

        return strtoupper(trim($base));
    }

    /**
     * Formata CPF no padr√£o XXX.XXX.XXX-XX.
     */
    private function formatCpf(?string $cpf): string
    {
        $digits = $this->digits((string) $cpf);
        if (strlen($digits) !== 11) {
            return '';
        }

        return sprintf(
            '%s.%s.%s-%s',
            substr($digits, 0, 3),
            substr($digits, 3, 3),
            substr($digits, 6, 3),
            substr($digits, 9, 2)
        );
    }

    private function isAddressDataEmpty(array $data): bool
    {
        // Remove 'complemento' da checagem, pois ele pode ser vazio
        unset($data['complemento']);

        // Se todos os outros campos (rua, num, bairro, etc)
        // concatenados forem uma string vazia, o endere√ßo est√° vazio.
        return empty(implode('', $data));
    }

    /**
     * Formata telefone no padr√£o (XX) XXXXX-XXXX ou XXXX-XXXX (se DDD for null).
     */
    private function formatTelefone(?string $ddd, ?string $numero): string
    {
        $dddDigits = $this->digits((string) $ddd);
        $numDigits = $this->digits((string) $numero);

        if ($numDigits === '') {
            return '';
        }

        // Padroniza para 8 ou 9 d√≠gitos no final
        $numDigits = substr($numDigits, -9);

        $len = strlen($numDigits);
        if ($len === 9) {
            $masked = substr($numDigits, 0, 5) . '-' . substr($numDigits, 5);
        } elseif ($len === 8) {
            $masked = substr($numDigits, 0, 4) . '-' . substr($numDigits, 4);
        } else {
            $masked = $numDigits;
        }

        return $dddDigits !== ''
            ? sprintf('(%s) %s', $dddDigits, $masked)
            : $masked;
    }

    /**
     * Normaliza data para Y-m-d para payload de retorno.
     */
    private function normalizeDate(mixed $value): string
    {
        if ($value instanceof \DateTimeInterface) {
            return $value->format('Y-m-d');
        }

        if (is_string($value)) {
            $value = trim($value);
            if (preg_match('~^\d{4}-\d{2}-\d{2}$~', $value)) {
                return $value;
            }
            $timestamp = strtotime($value);
            if ($timestamp) {
                return date('Y-m-d', $timestamp);
            }
        }
        return '';
    }

    /**
     * Constr√≥i o array de dados do usu√°rio para ser retornado na API.
     */
    private function buildUserPayload(Usuario $user): array
    {
        // ... (seu c√≥digo para $tipoCpf e $cpfAtual) ...
        // ... (seu c√≥digo para $tel, $ddd, $sexo) ...

        $tipoCpf = TipoDocumento::firstOrCreate(['ds_tipo' => 'CPF']);
        $cpfAtual = Documento::where('id_usuario', $user->id)
            ->where('id_tipo', $tipoCpf->id_tipo)
            ->value('numero');

        /** @var Telefone|null $tel */
        $tel = Telefone::where('id_usuario', $user->id)->orderBy('id_telefone')->first();

        /** @var Ddd|null $ddd */
        $ddd = $tel?->id_ddd ? Ddd::find($tel->id_ddd) : null;

        /** @var Sexo|null $sexo */
        $sexo = $user->id_sexo ? Sexo::find($user->id_sexo) : null;

        // üöÄ ADICIONADO: Carrega o endere√ßo principal
        /** @var Endereco $endereco */
        // Usamos o relacionamento que criamos no Model Usuario.
        // O withDefault() garante que $endereco nunca seja null.
        $endereco = $user->enderecoPrincipal;


        return [
            'id'                => (int) $user->id,
            'nome'              => (string) ($user->nome ?? ''),
            'email'             => (string) ($user->email ?? ''),
            'username'          => (string) ($user->username ?? ''),
            'avatar'            => (string) ($user->avatar ?? ''),
            'data_nascimento'   => $this->normalizeDate($user->data_nascimento),
            'sexo'              => $this->mapSexoToOption($sexo?->nm_sexo),
            'cpf'               => $this->formatCpf($cpfAtual),
            'telefone'          => $this->formatTelefone($ddd?->codigo, $tel?->numero),
            'endereco'          => [
                'cep'         => (string) $endereco->cep,
                'rua'         => (string) $endereco->rua,
                'numero'      => (string) $endereco->numero,
                'complemento' => (string) $endereco->complemento,
                'bairro'      => (string) $endereco->bairro,
                'cidade'      => (string) $endereco->cidade,
                'estado'      => (string) $endereco->estado,
            ]
        ];
    }

    // --- Endpoints da API ---

    /**
     * Retorna os dados do perfil do usu√°rio autenticado.
     */
    public function show(): void
    {
        try {
            /** @var Usuario|null $sessionUser */
            $sessionUser = Auth::user();
            if (!$sessionUser) {
                Response::error('Nao autenticado', 401);
                return;
            }

            /** @var Usuario|null $user */
            // Uso de find() retorna null, ideal para checagem 404
            $user = Usuario::find((int) $sessionUser->id);
            if (!$user) {
                Response::error('Usuario nao encontrado', 404);
                return;
            }

            Response::success([
                'user' => $this->buildUserPayload($user),
            ], 'Perfil carregado');
        } catch (Throwable $e) {
            Response::error('Erro interno', 500, ['exception' => $e->getMessage()]);
        }
    }

    /**
     * Atualiza os dados do perfil do usu√°rio.
     */
    public function update(): void
    {
        try {
            /** @var Usuario|null $sessionUser */
            $sessionUser = Auth::user();
            if (!$sessionUser) {
                Response::error('Nao autenticado', 401);
                return;
            }

            /** @var Usuario $user */
            $user = Usuario::findOrFail((int) $sessionUser->id); // findOrFail lan√ßa exce√ß√£o se n√£o encontrar

            // Tenta obter dados do POST.
            $nome = trim((string) ($_POST['nome'] ?? $user->nome ?? ''));
            $email = mb_strtolower(trim((string) ($_POST['email'] ?? $user->email ?? '')));
            $username = trim((string) ($_POST['username'] ?? $user->username ?? ''));
            $rawCpf = (string) ($_POST['cpf'] ?? '');
            $rawTel = (string) ($_POST['telefone'] ?? '');
            $rawSexo = (string) ($_POST['sexo'] ?? '');
            $rawNasc = (string) ($_POST['data_nascimento'] ?? '');

            // üöÄ NOVO: Recebe o array de endere√ßo do POST
            // Espera que o frontend envie como: endereco[cep], endereco[rua], etc.
            $endDataIn = (array) ($_POST['endereco'] ?? []);

            $endData = [
                'cep'         => $this->digits($endDataIn['cep'] ?? ''),
                'rua'         => trim($endDataIn['rua'] ?? ''),
                'numero'      => trim($endDataIn['numero'] ?? ''),
                'complemento' => trim($endDataIn['complemento'] ?? ''),
                'bairro'      => trim($endDataIn['bairro'] ?? ''),
                'cidade'      => trim($endDataIn['cidade'] ?? ''),
                'estado'      => strtoupper(trim($endDataIn['estado'] ?? '')),
            ];


            $errors = [];

            // 1. Valida√ß√£o B√°sica (Nome, Email, Username)
            // ... (seu c√≥digo de valida√ß√£o) ...
            if ($nome === '') {
                $errors['nome'] = 'Nome √© obrigat√≥rio.';
            }
            if ($email === '' || !filter_var($email, FILTER_VALIDATE_EMAIL)) {
                $errors['email'] = 'E-mail inv√°lido.';
            }
            if ($username !== '' && mb_strlen($username) < 3) {
                $errors['username'] = 'Username deve ter no m√≠nimo 3 caracteres.';
            }

            // 2. Valida√ß√£o CPF
            // ... (seu c√≥digo de valida√ß√£o) ...
            $cpf = $this->digits($rawCpf);
            if ($cpf !== '' && !$this->isValidCpf($cpf)) {
                $errors['cpf'] = 'CPF inv√°lido.';
            }

            // 3. Valida√ß√£o Data de Nascimento
            // ... (seu c√≥digo de valida√ß√£o) ...
            $nasc = $this->parseDate($rawNasc);
            if (trim($rawNasc) !== '' && $nasc === null) {
                $errors['data_nascimento'] = 'Data inv√°lida.';
            } elseif ($nasc && strtotime($nasc) > strtotime('today')) {
                $errors['data_nascimento'] = 'Data no futuro n√£o permitida.';
            }

            // 4. Valida√ß√£o Telefone
            // ... (seu c√≥digo de valida√ß√£o) ...
            [$dddCode, $foneLocal] = $this->splitPhone($rawTel);
            if ($rawTel !== '' && ($dddCode === null || $foneLocal === null)) {
                $errors['telefone'] = 'Telefone inv√°lido. Use DDD + n√∫mero.';
            }

            // üöÄ NOVO: Valida√ß√£o do Endere√ßo
            $isAddressEmpty = $this->isAddressDataEmpty($endData);

            // Se o endere√ßo N√ÉO estiver vazio, validamos os campos obrigat√≥rios
            if (!$isAddressEmpty) {
                // Valida CEP apenas se n√£o estiver vazio
                if ($endData['cep'] !== '' && strlen($endData['cep']) !== 8) $errors['endereco.cep'] = 'CEP inv√°lido.';
                if ($endData['rua'] === '') $errors['endereco.rua'] = 'Rua √© obrigat√≥ria.';
                if ($endData['numero'] === '') $errors['endereco.numero'] = 'N√∫mero √© obrigat√≥rio.';
                if ($endData['bairro'] === '') $errors['endereco.bairro'] = 'Bairro √© obrigat√≥rio.';
                if ($endData['cidade'] === '') $errors['endereco.cidade'] = 'Cidade √© obrigat√≥ria.';
                if ($endData['estado'] === '') $errors['endereco.estado'] = 'Estado (UF) √© obrigat√≥rio.';
                if ($endData['estado'] !== '' && strlen($endData['estado']) !== 2) $errors['endereco.estado'] = 'Estado (UF) deve ter 2 letras.';
            }

            $sexoLabel = $this->mapSexoLabel($rawSexo);

            if (!empty($errors)) {
                Response::validationError($errors);
                return;
            }


            // ... (Sua checagem de duplicidade de Email) ...
            $q = Usuario::whereRaw('LOWER(email) = ?', [$email])->where('id', '!=', $user->id);
            if ($q->exists()) {
                $errors['email'] = 'Este e-mail j√° est√° em uso.';
            }

            // ... (Sua checagem de duplicidade de Username) ...
            $q = Usuario::whereRaw('LOWER(username) = ?', [mb_strtolower($username)])->where('id', '!=', $user->id);
            if ($username !== '' && $q->exists()) {
                $errors['username'] = 'Este username j√° est√° em uso.';
            }

            // ... (Sua checagem de duplicidade de CPF) ...
            if ($cpf !== '') {
                $tipoCpf = TipoDocumento::firstOrCreate(['ds_tipo' => 'CPF']);
                $cpfEmUso = Documento::where('numero', $cpf)
                    ->where('id_tipo', $tipoCpf->id_tipo)
                    ->where('id_usuario', '!=', $user->id)
                    ->exists();

                if ($cpfEmUso) {
                    $errors['cpf'] = 'Este CPF j√° est√° em uso.';
                }
            }

            if (!empty($errors)) {
                Response::validationError($errors);
                return;
            }

            // üöÄ NOVO: Adiciona as vari√°veis de endere√ßo ao 'use' da transa√ß√£o
            DB::connection()->transaction(function () use (
                $user,
                $nome,
                $email,
                $username,
                $nasc,
                $sexoLabel,
                $cpf,
                $dddCode,
                $foneLocal,
                $rawTel,
                $endData,
                $isAddressEmpty // <-- üöÄ NOVO
            ) {
                // --- 1. Salva dados do Usu√°rio ---
                $user->nome = $nome;
                $user->email = $email;
                if ($username !== '') {
                    $user->username = $username;
                }
                $user->data_nascimento = $nasc;

                if ($sexoLabel !== null) {
                    $sexo = Sexo::firstOrCreate(['nm_sexo' => $sexoLabel]);
                    $user->id_sexo = $sexo->id_sexo;
                } else {
                    $user->id_sexo = null;
                }
                $user->save();

                // --- 2. Salva Documento (CPF) ---
                $tipoCpf = TipoDocumento::firstOrCreate(['ds_tipo' => 'CPF']);
                if ($cpf !== '') {
                    Documento::updateOrCreate(
                        ['id_usuario' => $user->id, 'id_tipo' => $tipoCpf->id_tipo],
                        ['numero' => $cpf]
                    );
                } else {
                    Documento::where('id_usuario', $user->id)
                        ->where('id_tipo', $tipoCpf->id_tipo)
                        ->delete();
                }

                // --- 3. Salva Telefone ---
                $tel = Telefone::where('id_usuario', $user->id)->orderBy('id_telefone')->first();

                if ($rawTel === '') {
                    $tel?->delete();
                } else {
                    $ddd = Ddd::firstOrCreate(['codigo' => $dddCode]);
                    $data = [
                        'numero' => $foneLocal,
                        'id_ddd' => $ddd->id_ddd,
                        'tipo' => $tel?->tipo ?? 'celular'
                    ];

                    if ($tel) {
                        $tel->fill($data)->save();
                    } else {
                        Telefone::create(array_merge($data, ['id_usuario' => $user->id]));
                    }
                }

                // --- 4. üöÄ NOVO: Salva o Endere√ßo ---
                if ($isAddressEmpty) {
                    // Se o usu√°rio limpou o formul√°rio, deletamos o endere√ßo principal
                    Endereco::where('user_id', $user->id)
                        ->where('tipo', 'principal')
                        ->delete();
                } else {
                    // Se tem dados, usamos updateOrCreate:
                    // Ele procura por [user_id + tipo 'principal']
                    // Se ACHAR, atualiza com $endData.
                    // Se N√ÉO ACHAR, cria um novo com $endData.
                    Endereco::updateOrCreate(
                        [
                            'user_id' => $user->id,
                            'tipo'    => 'principal' // Chaves para procurar
                        ],
                        $endData // Dados para inserir/atualizar
                    );
                }
            }); // Fim da Transa√ß√£o

            $user->refresh(); // Recarrega o usu√°rio com os dados atualizados

            Response::success([
                'message' => 'Perfil atualizado com sucesso',
                'user'    => $this->buildUserPayload($user),
            ]);
        } catch (Throwable $e) {
            $statusCode = ($e instanceof \Illuminate\Database\Eloquent\ModelNotFoundException) ? 404 : 500;
            Response::error('Erro interno ao atualizar perfil', $statusCode, ['exception' => $e->getMessage()]);
        }
    }
}
